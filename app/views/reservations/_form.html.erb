<script type="text/javascript">
$(function() {
  reservation = <%= raw(reservation_as_json( @reservation )) %>;
  rooms       = <%= raw(rooms_as_json( @rooms )) %>;
  groups      = <%= raw(groups_as_json( @groups )) %>;
  room_types  = <%= raw(room_types_as_json( @room_types )) %>;

  load_form();

});
</script>

<%= form_for @reservation, html: {class: "form-horizontal reservation_form"} do |f| %>

  <% if @reservation.errors.any? %>
    <div class="alert alert-error">
      <button type="button" class="close" data-dismiss="alert">×</button>
      <h3>Se encontraron <%= @reservation.errors.count %> errores:</h3>
      <ul>
      <% @reservation.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      <% @reservation.reservation_rooms.each do |rr| %>
        <% rr.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
        <% end %>
      <% end %>

      </ul>
    </div>
  <% end %>

  <% if notice %>
    <div class="alert alert-success">
      <button type="button" class="close" data-dismiss="alert">×</button>
      <p><%= notice %></p>
    </div>
  <% end %>

  <h3>Datos pasajero</h3>

  <div class="control-group">
    <%= f.label :passenger_id, 'Nombre', { class: 'control-label' } %>
    <div class="controls">
      <%= select("reservation", "passenger_id", @passengers.collect{ |p| [p.name+' '+p.lastname, p.id] }, { include_blank: true } ) %>
    </div>
  </div>
    
  <% if @enterprises.size > 0 %>
    <div class="control-group">
      <%= f.label :enterprise_id, { class: 'control-label' } %>
      <div class="controls">
        <%= select("reservation", "enterprise_id", @enterprises.collect{ |p| [p.name, p.id] }, { include_blank: true } ) %>
      </div>
    </div>
  <% end %>

  <h3>Habitaciones</h3>

  <!-- <div class="control-group">
    <label class="control-label">Habitaciones</label>
  </div> -->

  <% group_count = {}%>
  <% @rooms.each do |room| %>
    
    <% group = room.group  %>
    <% if( !group.nil? && !group_count[group.id] ) %>
    <% group_count[group.id] = 1 %>
    
    <div class="control-group">
      <%= label_tag group.id, group.name, class: 'control-label' %>
      <div class="controls">
        <% group_id = 'reservation_group_' + group.id.to_s %>
        <% group_name = 'reservation_group[' + group.id.to_s + ']' %>
        <input id="<%= group_id %>" class="room_selection" type="checkbox" value="1" name="chk_<%= group_name %>">
        <input id="<%= group_id %>_since" class="room_selection hide" type="text" name="<%= group_name %>[since]">
        <input id="<%= group_id %>_until" class="room_selection hide" type="text" name="<%= group_name %>[until]">
        <input id="<%= group_id %>_amount" class="room_selection hide" type="text" name="<%= group_name %>[amount]">
        <input id="<%= group_id %>_total" class="room_selection hide" type="text" name="<%= group_name %>[total]" disabled="disabled">
      </div>
    </div>
    <% end %>

    <div class="control-group">
      <%= label_tag room.id, room.number, class: 'control-label' %>
      <div class="controls">
        <% room_id = 'reservation_room_' + room.id.to_s %>
        <% room_name = 'reservation_room[' + room.id.to_s + ']' %>
        <input id="<%= room_id %>" class="room_selection" type="checkbox" value="1" name="chk_<%= room_name %>">
        <input id="<%= room_id %>_since" class="room_selection hide" type="text" name="<%= room_name %>[since]">
        <input id="<%= room_id %>_until" class="room_selection hide" type="text" name="<%= room_name %>[until]">
        <input id="<%= room_id %>_amount" class="room_selection hide" type="text" name="<%= room_name %>[amount]">
        <input id="<%= room_id %>_total" class="room_selection hide" type="text" name="<%= room_name %>[total]" disabled="disabled">
      </div>
    </div>
  <% end %>

  <div class="control-group">
    <%= f.label :amount, { class: 'control-label' } %>
    <div class="controls">
      <%= f.text_field :amount %>
    </div>
  </div>

  <div class="control-group">
    <%= f.label :observation, { class: 'control-label' } %>
    <div class="controls">
      <%= f.text_area :observation %>
    </div>
  </div>

  <div class="form-actions">
    <%= f.submit "Guardar", { class: 'btn btn-primary' } %>
    <%= link_to 'Atras', reservations_path, { class: 'btn' } %>
  </div>

<% end %>